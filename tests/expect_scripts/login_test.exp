#!/usr/bin/expect -f
# Login probe test: tries a sequence of common 4-digit codes and asserts that a "Welcome," line is produced.
# Usage: login_test.exp <path-to-published-target>

set timeout 8

if { $argc < 1 } {
    puts "Usage: $argv0 <published-target-path>"
    exit 2
}
set target [lindex $argv 0]

# Decide how to spawn: if target ends with .dll, run 'dotnet <dll>'; otherwise run the executable directly.
if {[string match "*.dll" $target]} {
    spawn -- dotnet $target
} else {
    spawn -- $target
}

# Wait for the login prompt to appear (approximate matching)
expect {
    -re "Please log in with your 4-digit user ID\\." {}
    timeout { puts "Login test: did not see login prompt"; exit 1 }
}

# Wait until "User ID:" prompt
expect {
    -re "User ID: " {}
    timeout { puts "Login test: did not see 'User ID:' prompt"; exit 1 }
}

# Candidate login codes to try (add or adjust values as needed for your users)
set candidates { "0000" "0001" "1234" "0423" "1111" "9999" }

# Try each candidate code until we see "Welcome," or until candidates exhausted
set success 0
foreach code $candidates {
    send -- "$code\r"

    expect {
        -re "Welcome,.*\\(" {
            puts "Login test PASSED: accepted code $code"
            set success 1
            break
        }
        -re "No user found with that ID\\. Try again\\." {
            # try next candidate
        }
        -re "Invalid format\\. The login code must be exactly 4 digits" {
            # try next candidate
        }
        eof {
            # process ended unexpectedly
            puts "Login test: process ended prematurely"
            exit 1
        }
        timeout {
            # timed out waiting for response - proceed to next candidate
            puts "Login test: timeout after trying $code"
        }
    }

    # If still running, try to re-sync to "User ID:" prompt before next attempt
    expect {
        -re "User ID: " {}
        timeout {}
    }
}

if { $success == 1 } {
    exit 0
} else {
    puts "Login test FAILED: no candidate code accepted. To make this deterministic, seed a test user or adjust candidates."
    exit 1
}