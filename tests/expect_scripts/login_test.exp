#!/usr/bin/expect -f
# Login probe test: tries a sequence of common 4-digit codes and asserts that a "Welcome," line is produced.
# This is a best-effort probe: it will pass if any of the probed codes are accepted by the app.

set timeout 6
# Candidate login codes to try (add or adjust values as needed for your users)
set candidates { "0000" "0001" "1234" "0423" "1111" "9999" }

spawn dotnet run --project . --no-build

# Wait for the login prompt to appear (approximate matching)
expect {
    -re "Please log in with your 4-digit user ID\\." {}
    timeout { puts "Login test: did not see login prompt"; exit 1 }
}

# Wait until "User ID:" prompt
expect {
    -re "User ID: " {}
    timeout { puts "Login test: did not see 'User ID:' prompt"; exit 1 }
}

# Try each candidate code until we see "Welcome," or until candidates exhausted
set success 0
foreach code $candidates {
    send -- "$code\r"
    # after sending, the app may print "No user found with that ID. Try again." or "Welcome, Name (Type)"
    expect {
        -re "Welcome,.*\\(" {
            puts "Login test PASSED: accepted code $code"
            set success 1
            break
        }
        -re "No user found with that ID\\. Try again\\." {
            # try next candidate
        }
        -re "Invalid format\\. The login code must be exactly 4 digits" {
            # not the right format -- continue trying
        }
        timeout {
            puts "Login test: timeout after trying $code"
            # try next code
        }
    }
    # ensure we see the "User ID: " prompt again before next try (some app flows might re-prompt)
    expect {
        -re "User ID: " {}
        timeout { /* do nothing; next attempt will still try to send input */ }
    }
}

if { $success == 1 } {
    exit 0
} else {
    puts "Login test FAILED: no candidate code accepted. To make this deterministic, add a known test user or seed users.txt in the repository for CI."
    exit 1
}