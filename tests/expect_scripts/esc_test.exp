#!/usr/bin/expect -f
# ESC test: spawn the published app and send an Escape key; expect the program to exit and print "Exiting..." within ~1s.

# Usage: esc_test.exp <path-to-published-target>
set timeout 3

if { $argc < 1 } {
    puts "Usage: $argv0 <published-target-path>"
    exit 2
}
set target [lindex $argv 0]

# Decide how to spawn: if target ends with .dll, run 'dotnet <dll>'; otherwise run the executable directly.
if {[string match "*.dll" $target]} {
    set spawn_cmd "dotnet"
    set spawn_arg $target
    spawn -- $spawn_cmd $spawn_arg
} else {
    # executable
    spawn -- $target
}

# small delay to let the app initialize
sleep 0.1
set start [clock milliseconds]

# Send ASCII Escape
send "\033"

# Wait for either the explicit "Exiting..." string, EOF (process ended), or timeout
expect {
    -re "Exiting\\.\\.\\." {
        # matched the expected message printed by ExitNow
    }
    eof {
        # process exited without printing the exact message
    }
    timeout {
        puts "ESC test: timeout waiting for exit message or process termination"
        exit 1
    }
}

set elapsed_ms [expr {[clock milliseconds] - $start}]
set elapsed_s [expr {double($elapsed_ms) / 1000.0}]

# Check that the program exited within 1 second (<= 1.0)
if { $elapsed_s > 1.0 } {
    puts "ESC test FAILED: program did not exit within 1s (elapsed ${elapsed_s}s)"
    exit 1
} else {
    puts "ESC test PASSED: program exited in ${elapsed_s}s"
    exit 0
}